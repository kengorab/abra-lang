<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Example</title>

    <script type="module">
      import main from './._abra/_main.mjs';

      const $td = new TextDecoder();
      const $te = new TextEncoder();

      function _decodeString(buf) {
        let i = buf.length - 1;
        while (i >= 0 && buf[i] === 0) { i--; }
        return $td.decode(buf.slice(0, i + 1));
      }

      const stdout = document.getElementById('stdout');

      // The `write` function appends to the #stdout element, and also outputs to the console.
      // When outputting to the console, make sure to disregard newlines and empty strings, since
      // `console` methods always append the newline.
      function write(fd, buf, _count) {
        let str = _decodeString(buf)
        stdout.innerHTML += str

        if (str.endsWith('\n')) { str = str.substring(0, str.length - 1); }
        if (!str.length) return;

        if (fd === 1) {
          console.log(str);
        } else if (fd === 2) {
          console.err(str);
        }
      }

      function strlen(str) {
        return str.length;
      }

      function getenv(key) {
        const keyStr = _decodeString(key)
        console.log(`getkey('${keyStr}'): unimplemented`)
        return null;
      }

      function errno() {
        return 0;
      }

      const externs = { write, strlen, getenv, errno };
      main(externs, []);
    </script>

</head>
<body>
    <h1>Stdout</h1>
    <pre id="stdout"></pre>
</body>
</html>